{{/*
  style/GetMainCSS
  Process the main css stylesheet and return as resource

  @author @regisphilibert

  @context Any (.)

  @returns Resource

  @uses
     - func/style/GetResource
*/}}
{{ $main_style := dict }}

{{ $assets_to_concat := collections.Slice }}
  {{ range collections.Slice "_tachyons.css" "_common.css" "_components.css" }}
    {{ with partials.IncludeCached "func/style/GetResource.html" . . }}
      {{ $assets_to_concat = $assets_to_concat | collections.Append . }}
    {{ end }}
  {{ end }}

{{/* We look for any custom css files registered by the user under `site.params.custom_css and if found in the theme's
css asset directory we (unless condition below) add to aforementioned slice */}}
{{ with site.Params.custom_css }}
  {{ range . }}
    {{ with partials.IncludeCached "func/style/GetResource.html" . . }}
      {{ if compare.Eq .MediaType.SubType "x-scss" "x-sass" "scss" "sass" }}
        {{ if hugo.IsExtended }}
          {{/* as we cannot concatenate styles of different types, we sass/scss to be transformed to css beforehand */}}
          {{ $assets_to_concat = $assets_to_concat | collections.Append (. | css.Sass) }}
        {{ else }}
          {{ partials.Include "func/warn.html" (fmt.Printf "Processing of stylesheet %s of type %s has been skipped. You need Hugo Extended to process such files." .Name .MediaType.SubType) }}
        {{ end }}
      {{ else }}
        {{ $assets_to_concat = $assets_to_concat | collections.Append . }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ with $assets_to_concat }}
  {{/* We proceed to concatenate the $assets_to_concat */}}
  {{ $style := . | resources.Concat "css/main.css" }}

  {{/* We then use toCSS to add sourceMap and minify */}}
  {{ $options := dict "enableSourceMap" true "precision" 6 }}
  {{ $style = $style | css.Sass $options | resources.Minify }}
  {{/* We fingerprint in production for cache busting purposes */}}
  {{ if hugo.IsProduction }}
    {{ $style = $style | resources.Fingerprint }}
  {{ end }}
  {{/* We're ready to set returning variable with resulting resource */}}
  {{ $main_style = $style }}
{{ end }}

{{ return $main_style }}
